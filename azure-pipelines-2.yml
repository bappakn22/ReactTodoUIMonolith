
trigger: none


pool: 
 vmImage: ubuntu-latest


#  name: jumpagent
#  demands:
#    - agent.name -equals jumpvmagent
  

stages:
  - stage: installnpm
    jobs:
      - job: npminstall
        steps:
        - task: Npm@1
          displayName: npm_install
          inputs:
            command: 'install'
            workingDir: '$(System.DefaultWorkingDirectory)'

        - task: Npm@1
          displayName: npm_build
          inputs:
            command: 'custom'
            workingDir: '$(System.DefaultWorkingDirectory)'
            customCommand: 'run build'

        - task: PublishPipelineArtifact@1
          displayName: publishartifacts
          inputs:
            targetPath: '$(System.DefaultWorkingDirectory)/build'
            artifact: 'todo_build'
            publishLocation: 'pipeline'

  - stage: deploy

    pool: jumpagent

    jobs:
      - job: deploy
        steps:
        - task: DownloadBuildArtifacts@1
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'todo_build'
            downloadPath: '$(System.ArtifactsDirectory)'
            cleanDestinationFolder: true

        # - task: CopyFilesOverSSH@0
        #   inputs:
        #     sshEndpoint: 'jumpsvc'
        #     sourceFolder: '$(System.ArtifactsDirectory)'
        #     contents: '**'
        #     targetFolder: '/tmp'
        #     readyTimeout: '20000'
        
        # - task: SSH@0
        #   inputs:
        #     sshEndpoint: 'jumpsvc'
        #     runOptions: 'commands'
        #     commands: |
        #       scp -r $(System.ArtifactsDirectory)/* devopsadmin@10.0.1.4:/tmp
              
        #       sudo cp -r /tmp/* /var/www/html
        #     readyTimeout: '20000'

        


        - task: SSH@0
          inputs:
            sshEndpoint: 'jumpsvc'
            runOptions: 'commands'
            commands: |
              scp -r $(System.ArtifactsDirectory)/* devopsadmin@10.0.1.4:/tmp
              
              scp -r $(System.ArtifactsDirectory)/* devopsadmin@10.0.1.5:/tmp
            readyTimeout: '20000'


        






        # - task: SSH@0
        #   inputs:
        #     sshEndpoint: 'jumpsvc'
        #     runOptions: 'commands'
        #     commands: 'ls /tmp'
        #     readyTimeout: '20000'

        # # - task: SSH@0
        # #   inputs:
        # #     sshEndpoint: 'jumpsvc'
        # #     runOptions: 'commands'
        # #     commands: 'sudo cp -r /tmp/* /var/www/html'
        # #     readyTimeout: '20000'
              
